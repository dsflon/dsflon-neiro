var source,sound={},userMedia={},fraction,localMediaStream,fistPlayFlag=!0,playing=!0,fileFlag=!1,userMediaFlag=!1,input,filter;fileReader.onload=function(){loading.className="active",playBtn.className="hide",fileWrap.className="hide",userMediaBtn.className="hide",startOffset=0,audioContext.decodeAudioData(fileReader.result,function(e){audioBuffer=e,loading.className="",sound.play()},function(e){console.error("decodeAudioData error",e)})},loadNote=function(){var e=new XMLHttpRequest;e.open("GET",SRC,!0),e.responseType="arraybuffer",e.onload=function(){audioContext.decodeAudioData(e.response,function(e){noteBuffer=e,audioBuffer=noteBuffer,loading.className="",sound.play()},function(e){console.error("decodeAudioData error",e)})},e.send()},sound.fistPlay=function(){loading.className="active",loadNote(),fistPlay=!1},sound.play=function(){userMediaFlag=!1,playing=!0,source&&(source.stop(),cancelAnimationFrame(animationId)),audioContext.createGain||(audioContext.createGain=audioContext.createGainNode),this.gainNode=audioContext.createGain(),fraction=parseInt(volumeBtn.value)/parseInt(volumeBtn.max),this.gainNode.gain.value=fraction,startTime=audioContext.currentTime,source=audioContext.createBufferSource(),source.buffer=audioBuffer,source.connect(analyser),source.connect(this.gainNode),this.gainNode.connect(audioContext.destination),source.loop=!0,source.start||(source.start=source.noteOn),source.start(0,startOffset%audioBuffer.duration),this.source=source,animationId=requestAnimationFrame(render),stopBtn.className="",volumeBtn.className=""},sound.stop=function(){this.source.stop||(this.source.stop=source.noteOff),this.source.stop(0),cancelAnimationFrame(animationId),startOffset+=audioContext.currentTime-startTime},sound.changeVolume=function(e){fraction=parseInt(e.value)/parseInt(e.max),this.gainNode.gain.value=fraction},sound.start=function(){playBtn.className="hide",fileWrap.className="hide",userMediaBtn.className="hide",fistPlayFlag?(this.fistPlay(),fistPlayFlag=!1):(startOffset=0,audioBuffer=noteBuffer,this.play())},sound.toggle=function(){playing?(playBtn.className="",fileWrap.className="",userMediaBtn.className="",stopBtn.className="play",volumeBtn.className="hide",userMediaFlag?(volumeBtn.className="hide",userMedia.stop()):this.stop(),playing=!1):(playBtn.className="hide",fileWrap.className="hide",userMediaBtn.className="hide",stopBtn.className="",volumeBtn.className="",userMediaFlag?(volumeBtn.className="hide",userMedia.start()):this.play(),playing=!0)},userMedia.start=function(){navigator.getUserMedia?(playBtn.className="hide",fileWrap.className="hide",userMediaBtn.className="hide",stopBtn.className="",playing=!0,userMediaFlag=!0,userMedia.play()):console.log("getUserMedia not supported")},userMedia.play=function(){navigator.getUserMedia({video:!1,audio:!0},function(e){localMediaStream=e,input=audioContext.createMediaStreamSource(e),filter=audioContext.createBiquadFilter(),filter.frequency.value=100,input.connect(filter),filter.connect(analyser),animationId=requestAnimationFrame(render)},function(e){console.log("The following error occured: "+e)})},userMedia.stop=function(){cancelAnimationFrame(animationId),-1!=userAgent.indexOf("chrome")?setTimeout(function(){location.reload()},400):localMediaStream.stop()};